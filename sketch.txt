
CREATE PIPELINE etl_customer_analytics (
  PARAMETER start_date DATE DEFAULT CURRENT_DATE - INTERVAL '30 days',
  PARAMETER customer_segment TEXT DEFAULT 'all',
  PARAMETER vip_threshold NUMERIC DEFAULT 1000,
  
  STAGE extract_orders 
    AS SELECT * FROM raw_orders 
       WHERE order_date >= $(start_date)
       AND ($(customer_segment) = 'all' OR customer_segment = $(customer_segment));

  STAGE transform_orders DEPENDS ON extract_orders
    AS SELECT 
        customer_id, 
        COUNT(*) as order_count,
        SUM(order_total) as total_spent
      FROM extract_orders
      GROUP BY customer_id;

  STAGE enrich_customers DEPENDS ON transform_orders
    AS SELECT 
        c.customer_id, c.name, c.email, 
        t.order_count, t.total_spent,
        CASE WHEN t.total_spent > $(vip_threshold) THEN 'VIP' ELSE 'Regular' END as segment
      FROM customers c
      JOIN transform_orders t ON c.customer_id = t.customer_id;

  STAGE load_analytics DEPENDS ON enrich_customers
    AS INSERT INTO customer_analytics
       SELECT * FROM enrich_customers;
);

EXECUTE PIPELINE etl_customer_analytics 
  SET start_date = '2025-01-01', 
      customer_segment = 'retail',
      vip_threshold = 500;

CREATE PIPELINE CONFIG retail_config FOR etl_customer_analytics
  SET start_date = '2025-01-01',
      customer_segment = 'retail',
      vip_threshold = 500;

EXECUTE PIPELINE etl_customer_analytics CONFIG retail_config;
